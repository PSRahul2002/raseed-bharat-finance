<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Receipt Data Frontend Integration Example</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .dashboard-header {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .stat-label {
            font-size: 12px;
            opacity: 0.9;
        }
        .filters {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .filter-group label {
            font-size: 12px;
            font-weight: bold;
            color: #666;
        }
        .filter-group input, .filter-group select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .receipt-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
        }
        .receipt-card {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            background: white;
        }
        .receipt-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 10px;
        }
        .vendor-name {
            font-weight: bold;
            color: #333;
        }
        .amount {
            color: #e74c3c;
            font-weight: bold;
            font-size: 18px;
        }
        .receipt-details {
            color: #666;
            font-size: 14px;
        }
        .category-badge {
            background: #3498db;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            display: inline-block;
            margin-top: 5px;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        .error {
            color: #e74c3c;
            background: #ffeaea;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success {
            color: #27ae60;
            background: #eafaf1;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .btn {
            background: #3498db;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover {
            background: #2980b9;
        }
        .analytics-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        .chart-placeholder {
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            padding: 40px;
            text-align: center;
            border-radius: 8px;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Receipt Data Fetch API - Frontend Integration Demo</h1>
        
        <!-- User Setup -->
        <div class="filter-group" style="margin-bottom: 20px;">
            <label>User Gmail ID:</label>
            <input type="email" id="userEmail" placeholder="user@gmail.com" value="test@gmail.com">
            <button class="btn" onclick="loadUserData()">Load User Data</button>
            <button class="btn" onclick="clearCache()">Clear Cache</button>
        </div>
        
        <!-- API URL Configuration -->
        <div class="filter-group" style="margin-bottom: 20px;">
            <label>API Base URL:</label>
            <input type="url" id="apiUrl" placeholder="https://receipt-data-fetch-api-593566622908.us-central1.run.app" value="https://receipt-data-fetch-api-593566622908.us-central1.run.app">
        </div>
        
        <!-- Status -->
        <div id="status"></div>
        
        <!-- Dashboard Header -->
        <div id="dashboard" class="dashboard-header" style="display: none;">
            <div class="stat-card">
                <div class="stat-value" id="totalReceipts">0</div>
                <div class="stat-label">Total Receipts</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalAmount">$0.00</div>
                <div class="stat-label">Total Spending</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="recentAmount">$0.00</div>
                <div class="stat-label">Recent (10)</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="walletPasses">0</div>
                <div class="stat-label">Wallet Passes</div>
            </div>
        </div>
    </div>
    
    <!-- Filters -->
    <div class="container">
        <h3>Filters</h3>
        <div class="filters">
            <div class="filter-group">
                <label>Category:</label>
                <select id="categoryFilter">
                    <option value="">All Categories</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Min Amount:</label>
                <input type="number" id="minAmount" placeholder="0.00" step="0.01">
            </div>
            <div class="filter-group">
                <label>Max Amount:</label>
                <input type="number" id="maxAmount" placeholder="1000.00" step="0.01">
            </div>
            <div class="filter-group">
                <label>Start Date:</label>
                <input type="date" id="startDate">
            </div>
            <div class="filter-group">
                <label>End Date:</label>
                <input type="date" id="endDate">
            </div>
            <div class="filter-group">
                <label>Limit:</label>
                <input type="number" id="limitFilter" value="20" min="1" max="100">
            </div>
        </div>
        <button class="btn" onclick="applyFilters()">Apply Filters</button>
        <button class="btn" onclick="clearFilters()">Clear Filters</button>
    </div>
    
    <!-- Receipts Display -->
    <div class="container">
        <h3>Receipts</h3>
        <div id="receipts" class="receipt-grid">
            <div class="loading">Click "Load User Data" to fetch receipts</div>
        </div>
    </div>
    
    <!-- Analytics -->
    <div class="container">
        <h3>Analytics (Last 30 Days)</h3>
        <button class="btn" onclick="loadAnalytics()">Load Analytics</button>
        <div id="analytics" class="analytics-section" style="display: none;">
            <div>
                <h4>Category Breakdown</h4>
                <div id="categoriesChart" class="chart-placeholder">
                    Category chart will appear here
                </div>
            </div>
            <div>
                <h4>Daily Spending</h4>
                <div id="spendingChart" class="chart-placeholder">
                    Spending chart will appear here
                </div>
            </div>
        </div>
    </div>
    
    <!-- LocalStorage Info -->
    <div class="container">
        <h3>LocalStorage Status</h3>
        <button class="btn" onclick="showCacheInfo()">Show Cache Info</button>
        <div id="cacheInfo"></div>
    </div>

    <script>
        // Global variables
        let baseUrl = '';
        let currentUser = '';
        let cachedData = null;
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadCategories();
            loadFromCache();
        });
        
        // API Helper functions
        async function apiCall(endpoint, params = {}) {
            baseUrl = document.getElementById('apiUrl').value.trim();
            if (!baseUrl) {
                throw new Error('Please enter API base URL');
            }
            
            const url = new URL(endpoint, baseUrl);
            Object.keys(params).forEach(key => {
                if (params[key] !== null && params[key] !== '') {
                    url.searchParams.append(key, params[key]);
                }
            });
            
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`API Error: ${response.status} ${response.statusText}`);
            }
            return response.json();
        }
        
        // Load categories for filter dropdown
        async function loadCategories() {
            try {
                const data = await apiCall('/categories');
                const select = document.getElementById('categoryFilter');
                select.innerHTML = '<option value="">All Categories</option>';
                data.categories.forEach(category => {
                    select.innerHTML += `<option value="${category}">${category}</option>`;
                });
            } catch (error) {
                console.log('Categories not loaded yet:', error.message);
            }
        }
        
        // Load user data
        async function loadUserData() {
            const email = document.getElementById('userEmail').value.trim();
            if (!email) {
                showStatus('Please enter a valid email address', 'error');
                return;
            }
            
            currentUser = email;
            showStatus('Loading user data...', 'loading');
            
            try {
                // Load summary first
                const summary = await apiCall(`/user-summary/${email}`);
                updateDashboard(summary);
                
                // Load receipts
                const receipts = await apiCall(`/user-data/${email}`, {limit: 50});
                displayReceipts(receipts.receipts);
                
                // Cache the data
                cachedData = {
                    user_id: email,
                    summary: summary,
                    receipts: receipts,
                    cached_at: new Date().toISOString()
                };
                localStorage.setItem('userReceiptData', JSON.stringify(cachedData));
                
                showStatus(`Successfully loaded ${receipts.total_count} receipts for ${email}`, 'success');
                document.getElementById('dashboard').style.display = 'grid';
                
            } catch (error) {
                showStatus(`Error loading data: ${error.message}`, 'error');
            }
        }
        
        // Apply filters
        async function applyFilters() {
            if (!currentUser) {
                showStatus('Please load user data first', 'error');
                return;
            }
            
            const filters = {
                category: document.getElementById('categoryFilter').value,
                min_amount: document.getElementById('minAmount').value,
                max_amount: document.getElementById('maxAmount').value,
                start_date: document.getElementById('startDate').value,
                end_date: document.getElementById('endDate').value,
                limit: document.getElementById('limitFilter').value || 20
            };
            
            showStatus('Applying filters...', 'loading');
            
            try {
                const data = await apiCall(`/user-data/${currentUser}`, filters);
                displayReceipts(data.receipts);
                showStatus(`Found ${data.total_count} receipts matching filters`, 'success');
            } catch (error) {
                showStatus(`Error applying filters: ${error.message}`, 'error');
            }
        }
        
        // Clear filters
        function clearFilters() {
            document.getElementById('categoryFilter').value = '';
            document.getElementById('minAmount').value = '';
            document.getElementById('maxAmount').value = '';
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            document.getElementById('limitFilter').value = '20';
            
            if (currentUser) {
                loadUserData();
            }
        }
        
        // Load analytics
        async function loadAnalytics() {
            if (!currentUser) {
                showStatus('Please load user data first', 'error');
                return;
            }
            
            try {
                const analytics = await apiCall(`/user-analytics/${currentUser}`, {days: 30});
                displayAnalytics(analytics);
                document.getElementById('analytics').style.display = 'grid';
                showStatus('Analytics loaded successfully', 'success');
            } catch (error) {
                showStatus(`Error loading analytics: ${error.message}`, 'error');
            }
        }
        
        // Update dashboard
        function updateDashboard(summary) {
            document.getElementById('totalReceipts').textContent = summary.total_receipts;
            document.getElementById('totalAmount').textContent = `$${summary.recent_total_amount?.toFixed(2) || '0.00'}`;
            document.getElementById('recentAmount').textContent = `$${summary.recent_total_amount?.toFixed(2) || '0.00'}`;
            document.getElementById('walletPasses').textContent = summary.wallet_passes_count;
        }
        
        // Display receipts
        function displayReceipts(receipts) {
            const container = document.getElementById('receipts');
            
            if (!receipts || receipts.length === 0) {
                container.innerHTML = '<div class="loading">No receipts found</div>';
                return;
            }
            
            container.innerHTML = receipts.map(receipt => `
                <div class="receipt-card">
                    <div class="receipt-header">
                        <div class="vendor-name">${receipt.vendor_name || 'Unknown Vendor'}</div>
                        <div class="amount">$${(receipt.total_amount || 0).toFixed(2)}</div>
                    </div>
                    <div class="receipt-details">
                        <div>Date: ${receipt.date || 'Unknown'}</div>
                        <div>ID: ${receipt.id.substring(0, 8)}...</div>
                        <div class="category-badge">${receipt.bill_category || 'Other'}</div>
                    </div>
                </div>
            `).join('');
        }
        
        // Display analytics
        function displayAnalytics(analytics) {
            // Categories chart
            const categoriesChart = document.getElementById('categoriesChart');
            const categoriesHtml = Object.entries(analytics.categories)
                .map(([category, count]) => `<div>${category}: ${count} receipts</div>`)
                .join('');
            categoriesChart.innerHTML = categoriesHtml || 'No category data';
            
            // Daily spending chart
            const spendingChart = document.getElementById('spendingChart');
            const dailyHtml = Object.entries(analytics.daily_spending || {})
                .slice(-7) // Last 7 days
                .map(([date, amount]) => `<div>${date}: $${amount.toFixed(2)}</div>`)
                .join('');
            spendingChart.innerHTML = dailyHtml || 'No spending data';
        }
        
        // Cache management
        function loadFromCache() {
            const cached = localStorage.getItem('userReceiptData');
            if (cached) {
                try {
                    cachedData = JSON.parse(cached);
                    document.getElementById('userEmail').value = cachedData.user_id;
                    showStatus('Cached data available - click "Load User Data" to refresh', 'success');
                } catch (error) {
                    console.error('Error loading cache:', error);
                }
            }
        }
        
        function clearCache() {
            localStorage.removeItem('userReceiptData');
            cachedData = null;
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('receipts').innerHTML = '<div class="loading">Cache cleared - click "Load User Data" to fetch receipts</div>';
            showStatus('Cache cleared', 'success');
        }
        
        function showCacheInfo() {
            const info = document.getElementById('cacheInfo');
            if (cachedData) {
                info.innerHTML = `
                    <div><strong>Cached User:</strong> ${cachedData.user_id}</div>
                    <div><strong>Cached At:</strong> ${new Date(cachedData.cached_at).toLocaleString()}</div>
                    <div><strong>Receipts Count:</strong> ${cachedData.receipts?.total_count || 0}</div>
                    <div><strong>Data Size:</strong> ${(JSON.stringify(cachedData).length / 1024).toFixed(2)} KB</div>
                `;
            } else {
                info.innerHTML = '<div>No cached data available</div>';
            }
        }
        
        // Show status messages
        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.className = type;
            status.textContent = message;
            
            if (type === 'loading') {
                status.innerHTML = `<div>${message} ⏳</div>`;
            }
        }
    </script>
</body>
</html>
